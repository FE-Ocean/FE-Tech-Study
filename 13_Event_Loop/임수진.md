# 이벤트 루프 (Event Loop)
### - 콜 스택과 태스크 큐를 주시하고, 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킨다. <br>`콜 스택`에 실행 중인 실행 컨텍스트가 있는지, `태스크 큐`에 대기 중인 함수가 있는지 반복해서 확인하고, <br>콜 스택이 비어있고 태스크 큐에 대기 중인 함수가 있다면, 이벤트 루프는 순차적으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킨다.

- 싱글 스레드로 동작하는 자바스크립트의 동시성을 지원
- 브라우저에 내장되어 있는 기능 중 하나
<br><br>


## 이벤트 루프와 브라우저 환경
<img width="740" alt="브라우저 환경" src="https://github.com/etoile-j/Coding-Test/assets/102905624/9a2bfeab-8ea7-442c-a46f-b7d13862fac0">

- 크게 힙(heap)과 콜 스택(call stack)으로 구분되는 **자바스크립트 엔진**은 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행한다.

- 비동기 처리 시 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 Node.js가 담당한다. 이를 위해 브라우저 환경은 `태스크 큐`와 `이벤트 루프`를 제공한다.


### 🔖 태스크 큐 (task queue/event queue/callback queue)
- setTimeout 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
- 태스크 큐에 일시 보관된 함수들은 비동기 처리 방식으로 동작


### 🔖 Web API
- ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API
- 작동이 완료되면 콜백 함수를 태스크 큐에 넣음
- DOM API와 타이머 함수, HTTP 요청(Ajax)과 같은 비동기 처리가 포함됨
<br><br>


### 동작 예시
```js
function lim() {
    console.log('lim');
}

function su() {
    console.log('su');
}

function jin() {
    console.log('jin');
}

setTimeout(lim, 0);
su();
jin();
```
1. `전역 코드`가 평가되어 전역 실행 컨텍스트가 생성되고 콜 스택에 푸시된다.
2. `setTimeout`이 콜 스택에 푸시되고, Web API에서 0초(4ms) 실행된다. 실행 후 콜백 함수 `lim`을 태스크 큐에 푸시한다.
<br>(* 지연 시간이 4ms 이하인 경우 최소 지연 시간 4ms가 지정된다.)
3. `setTimeout`이 콜 스택에서 팝된다.
4. `su` 함수가 호출되어 콜 스택에 푸시되고, 콘솔에 'su'를 출력한 후 콜 스택에서 팝된다.
5. `jin` 함수가 호출되어 콜 스택에 푸시되고, 콘솔에 'jin'를 출력한 후 콜 스택에서 팝된다.
6. `전역 코드` 실행이 끝나고 콜 스택에서 팝된다.
7. 이제 콜 스택이 완전히 비었기 때문에 **이벤트 루프**에 의해 감지되고, 
태스크 큐에 들어있던 콜백 함수 `lim`이 **이벤트 루프**에 의해 콜 스택에 푸시된다.
8. 콘솔에 'lim'을 출력하고 콜백 함수 `lim`이 콜 스택에서 팝된다.

- 콘솔

    ```
    su
    jin
    lim
    ```
------

### 🔖 setTimeout
- 일정 시간이 경과된 이후 콜백 함수가 호출되도록 타이머를 생성
- 타이머를 설정하고, 타이머가 만료되면 콜백 함수를 태스크 큐에 등록함
- 타이머 시간이 4ms 이하인 경우 최소 지연 시간 4ms가 지정
- setTimeout 함수의 콜백 함수는 타이머가 만료되면 단 *한 번 호출*되고, 
<br>`setInterval` 함수의 콜백 함수는 타이머가 만료될 때마다 *반복 호출*
- ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 함수
<br><br>


### 🔖 마이크로태스크 큐 (microtask queue/job queue)
- 태스크 큐와는 별도의 큐로 **프로미스의 후속 처리 메서드의 콜백 함수가 일시 저장**
- 콜백 함수나 이벤트 핸들러를 일시 저장하다는 점에서 태스크 큐와 동일하지만 **마이크로태스크 큐는 태스크 큐보다 우선순위가 높다** 

    이벤트 루프는 콜 스택이 비면 먼저 마이크로태스크 큐에서 대기하고 있는 함수를 가져와 실행한다. 
    이후 마이크로태스크 큐가 비면 태스크 큐에서 대기하고 있는 함수를 가져와 실행한다.
<br><br><br>



#### Reference
- 책 <모던 자바스크립트 Deep Dive>
- https://www.youtube.com/watch?v=8aGhZQkoFbQ
